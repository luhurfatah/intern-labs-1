# Lab 03: EC2 & S3 Storage

| Difficulty | Est. Time | Prerequisites |
|------------|-----------|---------------|
| Intermediate| 60 Mins   | Lab 02        |

## üéØ Objectives
- Launch and configure an Amazon EC2 instance.
- Automate server setup using **User Data**.
- Understand physical block storage (**EBS**) and its persistence.
- Store and retrieve files from Object Storage (**S3**).

---

## üó∫Ô∏è Architecture Overview

```mermaid
graph LR
    %% Styling (AWS Standards)
    classDef subnet fill:none,stroke:#8c4fff,stroke-width:2px,stroke-dasharray: 5 5;
    classDef compute fill:none,stroke:#ff9900,stroke-width:2px;
    classDef s3 fill:none,stroke:#3b48cc,stroke-width:2px;
    classDef external fill:none,stroke:#545b64,stroke-width:1px;

    subgraph PubSub ["Public Subnet"]
        EC2[EC2 Instance]
        EBS[(EBS Volume)]
        EC2 --- EBS
    end
    
    S3((S3 Bucket))
    EC2 -- "API Access" --> S3
    Internet[Internet] -- "HTTP (Port 80)" --> EC2

    %% Assign Classes
    class PubSub subnet;
    class S3 s3;
    class EC2,EBS compute;
    class Internet external;
```

---

## üìö Concepts

### 1. EC2: The CPU & RAM
EC2 (Elastic Compute Cloud) provides virtual servers. 
- **AMI (Amazon Machine Image)**: The "Gold Image" or template (OS + Software) for your server.
- **Instance Types**: `t3.micro` is part of the "Burstable" family, suitable for low-intensity workloads.

### 2. User Data: Your First Automation
When an EC2 instance starts for the *first time*, it can run a shell script. This is called **bootstrapping**. It allows you to install web servers or config files automatically.

### 3. EBS vs S3 (The "Where do I put it?" guide)
| Feature | EBS (Elastic Block Store) | S3 (Simple Storage Service) |
|---------|---------------------------|-----------------------------|
| **Format** | Block Storage (HDD/SSD) | Object Storage (API-based) |
| **Typical Use**| OS Drives, Databases | Media, Backups, Static Sites |
| **Scope** | Regional (tied to an AZ) | Global (accessible via URL) |
| **Speed** | Ultra-low latency | High throughput, higher latency |

---

## üõ†Ô∏è Step-by-Step Lab

### Step 1: Launch a Self-Configuring Web Server
1.  Navigate to **EC2** > **Instances** > **Launch Instance**.
2.  **Name**: `My-Web-Server`
3.  **AMI**: Amazon Linux 2023.
4.  **Network Settings**: 
    - VPC: `Intern-VPC`.
    - Subnet: `Public-Subnet`.
    - Auto-assign Public IP: **Enable**.
5.  **Security Group**: Create a new one named `Web-SG`. Allow **HTTP (Port 80)** from `0.0.0.0/0`.
6.  **Advanced Details**: Scroll to the bottom to **User Data** and paste:
    ```bash
    #!/bin/bash
    dnf update -y
    dnf install -y httpd
    systemctl start httpd
    systemctl enable httpd
    # Get instance ID from metadata service (IMDSv2)
    TOKEN=`curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600"`
    ID=`curl -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/meta-data/instance-id`
    echo "<h1>Welcome to the Intern Web Server!</h1><p>Instance ID: $ID</p>" > /var/www/html/index.html
    ```

### Step 2: Verify the Web Server
1.  Wait for the status to show "Running."
2.  Paste the **Public IPv4 address** into your browser. 
3.  **Explanation**: If you see your Instance ID, the bootstrapping via UserData was successful!

### Step 3: Add a Second "Hard Drive" (EBS)
1.  Go to **Volumes** > **Create Volume**. 10 GiB, same AZ as your instance.
2.  Select volume > **Actions** > **Attach Volume**.
3.  Login via **SSM Session Manager** or **EC2 Instance Connect** and run:
    ```bash
    lsblk # Confirm disk existence
    sudo mkfs -t xfs /dev/xvdf # Format
    sudo mkdir /data           # Mount point
    sudo mount /dev/xvdf /data # Attach
    echo "Stateful data" | sudo tee /data/notes.txt
    ```

---

## ‚ùì Troubleshooting & Pitfalls

- **User Data Failed**: Check logs on the instance at `/var/log/cloud-init-output.log`.
- **IMDSv2**: Modern AMI's require a "Token" to access instance metadata (the `curl -X PUT` command in UserData).
- **AZ Mismatch**: You cannot attach an EBS volume in `us-east-1a` to an instance in `us-east-1b`.

---

## üß† Lab Tasks: The Data Survivor
**Goal**: Practice EBS persistence across instance lifecycles.

1.  **Preparation**: Attach a 5GB EBS volume to your running instance. Mount it to `/mnt/data` and create a file named `important.txt` inside it.
2.  **Termination Test**: Terminate the instance. **Crucial**: Ensure "Delete on Termination" is unchecked for the 5GB volume before confirming.
3.  **The Recovery**: Launch a *new* instance in the same AZ. Attach the *same* 5GB volume.
4.  **Verification**: Mount the volume to the new instance and confirm that `important.txt` is still there. Provide the `ls -l` output.

---

## üßπ Cleanup
- Terminate EC2 instances.
- Delete the 10GB EBS volume.
- (Optional) Use `aws s3 rb` if you created buckets.
